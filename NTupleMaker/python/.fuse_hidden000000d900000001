from math import fabs, log10, sin, cos, acos
from ROOT import TFile, TChain

def areEqual( x1, x2):
    if( x1 == 0. or x2 == 0.):
        if( fabs(x1-x2) > 1.e-5):
            return False
    else:
        if (x1 * x2 < 0.):
            return False
        else:
            if (fabs(log10(fabs(x1))-log10(fabs(x2))) > 1.e-5):
                return False
    return True

def dPhiFrom2P( Px1, Py1, Px2, Py2):
    prod = Px1*Px2 + Py1*Py2

    mod1 = sqrt(Px1*Px1+Py1*Py1)
    mod2 = sqrt(Px2*Px2+Py2*Py2)
    
    cosDPhi = prod/(mod1*mod2)
    
    return acos(cosDPhi)


def deltaR( Eta1, Phi1,	Eta2, Phi2):
    Px1 = cos(Phi1)
    Py1 = sin(Phi1)

    Px2 = cos(Phi2)
    Py2 = sin(Phi2)

    dPhi = dPhiFrom2P(Px1,Py1,Px2,Py2)
    dEta = Eta1 - Eta2

    return sqrt(dPhi*dPhi+dEta*dEta)

def load_entries(tree):
    l=[]
    for ievt in range(tree.GetEntries()):
        tree.GetEntry(ievt)
        l.append((ievt, int(tree.evt)))

    l.sort(key=lambda x: x[1])

    return l

class CompareSpring15:
    def __init__(self):
        self.ref=""
        self.test=""
        
        self.cref=None
        self.ctest=None

        self.lref=[]
        self.ltest=[]

        self.ref_missing=[]
        self.test_missing=[]

        self.bad_events=[]
        self.bad_leptons=[]
        self.bad_met=[]
        self.bad_mvamet=[]
        self.bad_jets=[]

        self.good_events=[]
    
    def load(self, ref, test):
        self.ref=ref
        self.test=test
                
        self.cref=TChain(ref.split(":")[1])
        self.ctest=TChain(test.split(":")[1])

        self.cref.Add(ref.split(":")[0])
        self.ctest.Add(test.split(":")[0])

        self.lref=load_entries( self.cref)
        self.ltest=load_entries( self.ctest)

        
    def Compare(self):
        print self.cref.GetEntries(), self.ctest.GetEntries()

        iref=0
        itest=0        
        while(iref<len(self.lref)):
            ref_id=self.lref[iref][1]
            
            while(itest<len(self.ltest)):
                test_id=self.ltest[itest][1]
  
                if(test_id<ref_id):
                    self.ref_missing.append(self.ltest[itest])
                elif(test_id >ref_id):
                    self.test_missing.append(self.lref[iref])
                    break
                else:
                    itest+=1
                    break
                itest+=1
                
            if(test_id != ref_id):
                iref+=1
                continue


            isGood = True

            self.cref.GetEntry(self.lref[iref][0])
            self.ctest.GetEntry(self.ltest[itest][0])

            # compare leptons
            if( not areEqual(self.cref.pt_1, self.ctest.pt_1) or
                not areEqual(self.cref.iso_1, self.test.iso_1) or
                not areEqual(self.ref.pt_2, self.test.pt_2) or
                not areEqual(self.ref.iso_2, self.test.iso_2)):

                isGood = False;

                print "Event", self.lref[iref][1]
                line="    lep1: pt="+str(self.cref.pt_1)+" "+str(self.ctest.pt_1)
                line+=", eta="+str(self.cref.eta_1)+" "+str(self.ctest.eta_1)
                line+=", phi="+str(self.cref.phi_1)+" "+str(self.ctest.phi_1)
                line+=", iso="+str(self.cref.iso_1)+" "+str(self.ctest.iso_1)
                line+=", q="+str(self.cref.q_1)+" "+str(self.ctest.q_1)
                print line
                line="    lep2: pt="+str(self.cref.pt_2)+" "+str(self.ctest.pt_2)
                line+=", eta="+str(self.cref.eta_2)+" "+str(self.ctest.eta_2)
                line+=", phi="+str(self.cref.phi_2)+" "+str(self.ctest.phi_2)
                line+=", iso="+str(self.cref.iso_2)+" "+str(self.ctest.iso_2)
                line+=", q="+str(self.cref.q_2)+" "+str(self.ctest.q_2)
                print line

                refDR=deltaR(self.cref.eta_1, self.cref.phi_1, self.cref.eta_2, self.cref.phi_2)
                testDR=deltaR(self.ctest.eta_1, self.ctest.phi_1, self.ctest.eta_2, self.ctest.phi_2)
                                                       print "    deltaR(lep1, lep2)=",refDR" ",testDR
                print line

                bad_laptons.append(self.lref[iref],self.ltest[itest])
            
            iref+=1

            
    def Print(self):
        
        print len(self.ref_missing), "Events missing in ref tree"
        print len(self.test_missing), "Events missing in test tree"
        
        print "Events missing in test tree:"
        print [x[1] for x in self.test_missing]

        print
        print "Events missing in ref tree:"
        print [x[1] for x in self.ref_missing]

        print
        print "Events with bad leptons"
        print [x[0][1] for x in self.bad_leptons]
